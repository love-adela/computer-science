# 마이크로프로세서

      * 마이크로프로세서의 구조와 원리에 대해 설명할 수 있다.
      * 마이크로프로세서 칩의 종류, 동작 순서에 대해 설명할 수 있다.

## 1. 마이크로프로세서란

마이크로프로세서는 CPU와 이것저것을 통합한 것이긴 한데 CPU로 보아도 무방하다. 메모리에 내장되어 있는 명령을 해석하고 실행하는 기능을 함.

* 마이크로프로세서: Micro(아주 작은) + Processor(처리기)
* CPU(Control Processing Unit)라고 불리기도 하고, MPU(Micro Processing Unit)라고 불리기도 한다.
* 활용: IC 집적 기술, 시스템 프로그래밍 기술을 단일 칩에 집적화

### 1.1 발전 역사

1. 최초의 마이크로프로세서

1969년도 Intel 4004 : 4비트 마이크로프로세서
1980년에 개발 : Intel 8051 시리즈, 범용 마이크로프로세서, 플레시메모리로 개발, 주변장치로 활용

2. 마이크로프로세서의 종류

* Microchip (PIC) 시리즈
RISC 방식과 하버트 구조를 가진다.
고성능 8bit, 마이크로컨트를러 (마이크로프로세서 + 제어)
ISP(In-System Programming) 기능: 사용자가 작성한 프로그램을 MCU 내의 플래시 ROM에 다운로드가 가능하다.
초저가, 산업용

* Atmel (AVR) 시리즈
고성능 8bit 컨트롤러
RISC 방식과 하버트 구조를 가진다.
대용량의 플래시 메모리가 내장되어 있음.
반복적 프로그래밍 가능. 산업현장에서 사용이 증가
ISP 기능
Atmega가 인기

### 1.2 마이크로프로세서의 구조 및 구성 요소

1. 실행장치(Execution Unit)

  * 연산장치 ALU
    * Register
    * 제어장치(CU)

2. 명령어 장치(Instruction Unit)

  * 메모리에서 가져온 명령어를 저장
  * 저장된 명령어를 명령어 해석기에 명령어를 해석하여 제어 장치로 전달됨

3. 어드레싱 장치(Addressing Unit)
CPU 또는 MPU가 메모리나 입출력 장치에서 데이터를 읽거나 쓸 때, 메모리나 입출력 장치의 주소를 생성

4. 버스 인터페이스 (Bus Interface Unit)
  * 데이터 버스를 통해 외부장치들과 상호 연결: 주소가 지정되고 메모리로부터 데이터를 읽어오거나 기록할 때
  * 마이크로 프로세서 외부장치들과 상호 연결: 어드레스, 데이터, 컨트롤 버스를 통해서 한다.

### 1.3 마이크로프로세서의 동작

1. 어드레스 장치에서 명령어나 데이터가 저장되어 있는 메모리 번지를 계산한다. 어드레서 버스로 주소를 전송한다.
2. 버스 인터페이스 장치에서는 지정된 메모리 주소의 내용을 데이터 버스를 통해 읽거나 써넣는다.
3. 만약 읽어들인 데이터가 명령어이면 Prefetch Queue에 저장, 읽어들인 데이터가 Operand이면 명령어 장치는 프리패치 큐에서 명령어를 읽어서 해석(decoding)-> 해석된 명령어 (decoded instruction)를 실행장치로 전송
실행장치의 제어장치는 해석된 명령어에 따라서 ALU 및 레지스터들을 제어

### 1.4 마이크로프로세서의 분류

#### 1.4.1 설계 방식(명령어 구성 방식)에 따른 분류

1. RISC: 단순한 명령어 셋트를 지원하는 프로세서

* 명령어: 단순. 고정길이. 적은 명령어 수 (30~1000)
* Decoding: hardwired
* ~256개의 내부 레지스터
* 전력 소모가 적고 속도가 빠르며 가격이 저렴
* 호환성이 부족하다.
* 모토롤라 68계열, 매킨토시, 서버, 워크스테이션에 사용한다.
* 분리된 명령어 및 데이터 버스 사용(하버드 구조), 멀티태스킹 기능

2. CISC: 복잡한 명령어를 지원하는 프로세서

* 명령어: 복잡한 가변길이. 많은 명령어 수 (100~250)
* Decoding: micro-programmed
* 전력/속도/가격: 전력 소모가 크고 속도가 느리며 가격이 비싸다.
* 호환성이 좋음. 범용적.
* 사용 예: 386, 486, 펜티엄 등 PC용 CPU에 사용된다.
* 분리된 명령어 및 데이터 버스를 사용(하버드 구조)

#### 1.4.2. 데이터버스, ALU 및 레지스터들의 크기에 따른 분류

1. 8bit프로세서
1970년대 마이크로프로세서
소량의 마이크로컨트롤러가 존재
8051, AVR, PIC, SAM88

2. 16bit 프로세서
1980년대 초의 마이크로프로세서
8bit와 32bit발달로 많이 사용하지 않음
AM188, MSP430

3. 32bit 프로세서
1980년대 중반부터 지금까지 활발하게 사용되어 지는 마이크로컨트롤러
PC 또는 대용량의 데이터 처리를 하는 산업용 장치에 사용

#### 1.4.3. 용도(기능)에 따른 분류

1. MPU(Micro Processor Unit)
연산/제어 장치 및 각종 레지스터들을 1개의 IC 소자에 사용

2. MCU
One-Chip 프로세서: CPU, 메모리(ROM, RAM등) 입출력 제어 인터페이스 회로까지 내장한 것
MPU의 기능을 일부 축소하고 제어기능 추가
예: I8051, AVR, PIC,Cortex 등,

3. DSP
디지털 신호를 하드웨어적으로 처리할 수 있음
MPU의 기능을 일부 축소하고 고속 연산 기능 추가
특수 목적: 신호처리, 영상처리
예: TMS 시리즈

### 1.5 마이크로프로세서 관련 전자 부품

1. 기본 부품

* PCB기판 (빵판)
* 저항 (Resister)
  * 저항은 저항 값이 고정된 것과 가변되는 것, 그리고 여러 개의 저항이 하나의 부품으로 된 Array 저항이 있음.
* 콘덴서(Condeser, Capacitor)
  * 전기를 축적하는 기능
  * 잡음을 제거하거나 발진 회로를 구성할 때 자주 이용
* 다이오드 (Didode)
  * 전류를 한쪽 방향으로만 흘리는 반도체
  * 전류용 다이오드는 전원 장치에서 교류 전압을 직류 전압으로 바꿀 때 사용
  * 에노드(+) 캐소드(-) 2개 단자를 가진다.
  * 에노드 전압이 캐소드 전압보다 높을 때 전류가 흐른다.
* 트랜지스터 (Transistor)
  * 아날로그 회로에서 입력 신호를 증폭하기 위해 사용된다.
  * 디지털회로에서는 스위칭용으로 사용
  * 다이오드가 2개 연결된 것과 같은 구조를 하고 있다. 3개의 단자 E(Emitter), B(Base), C(Collector)를 가진다.
* CPU
  * 마이크로프로세서 또는 마이크로컨트롤러
* Crystal
  * CPU에 공급하는 클럭 발생을 위해 반드시 사용해야 하는 부품
  * CPU 내부의 발진 회로 단자에 콘덴서와 같이 연결하여 사용한다.
* 메모리
  * 프로그램이나 데이터를 저장하기 위해 사용된다.
* 디지털 IC
  * 마이크로컴퓨터 회로에서 디지털 논리 회로를 구성할 때 사용된다.
  * TTL(74 시리즈)이나 CMOS가 주로 사용된다.
* 스위치
  * 스위치의 상태에 따라 입력 값이 다르게 CPU로 입력되도록 회로를 구성하여 사용한다.
* 센서
* 부저(Buzzer)
  * 출력 상태를 삐 소리로 알려준다.
* LED
  * 에노드(+) 캐소드(-) 2개 단자를 가진다.
* 7-Segment
  * 숫자를 표시할 때 사용한다.
* Dot Matrix LED: 2차원적으로 LED를 배열한 것으로 문자, 기호, 여러가지 패턴을 표시한다.

## 2. 마이크로컨트롤러란

USB나 작은 기계 장치 안에 들어가는 아주 작은 컴퓨터를 뜻한다.

* 마이크로+ 컨트롤러
* 매우 작은 제어기
* 마이크로프로세서의 연산 처리기능에 제어기능이 추가된 것.

### 2.1 마이크로프로세서와 마이크로컨트롤러

      시스템 버스: CPU와 시스템 버스 간의 접속
      * 주소버스: 단방향성(unidirectional)
        - CPU에서 외부로 발생하는 주소 정보 전송 신호선 
        - 주소 선의 수는 CPU와 접속되는 최대 기억장치 용량 결정 
        - 주소 버스의 비트 수 = 16비트라면, 최대 2 ^ 16 = 64K개의 기억 장소들의 주소지정이 가능하다.
      * 데이터버스: 양방향성(bidirectional)
        - CPU가 기억장치 또는 I/O 장치간의 데이터 전송 신호 선
        - 데이터 선의 수는 CPU가 한번에 전송할 수 있는 비트 수를 결정
        - 데이터 버스 폭 = 32비트라면 CPU와 기억 장치 간의 데이터 전송은 한 번에 32 비트씩 가능하다.
      * 제어버스: 양방향성(bidirectional) 읽기와 쓰기 동작을 모두 지원한다.
        - CPU가 시스템 내의 각종 장치들의 동작을 제어하기 위한 신호 선
        - 기억장치의 읽기/쓰기(memory read/write) 신호
        - 입출력 장치의 입력/출력 (I/O input/output) 신호
        - 인터럽트 신호
        - 버스제어 신호

### 2.2 마이크로컨트롤러 구조

입력장치 (센서, 스위치)에 붙어서 이 장치로 신호가 들어오고 메모리에 신호가 저장된다.
제어기능에 대한 출력장치는 모터, Display로 나옴.

### 2.3 마이크로컨트롤러의 장단점

1. 장점

* 제품의 소형화 및 경량화
* 저렴한 가격
* 신뢰성 향상
* 융통성

2. 단점

* 낮은 처리 능력
* 범용성 부족

## 3. 마이크로컨르톨러 : ATmega128이란?

      * ATmega128의 특징
      * ATmega128의 메모리와 주변장치 및 동작 환경

### 3.1 ATmega128

고 성능의 저 전력 8비트 마이크로컨트롤러

* Atmel 사에서 개발 출시하는 AVR시리즈
* 지보된 RISC구조
  - 133개의 강력한 명령어: 대부분 1클록 사이클에서 실행
  - 단일 클럭 내에서 하나의 명령어를 실행(1MHz당 1MIPS의 성능)

### 3.2 ATmega128의 특징

#### 3.2.1 진보된 RISC 구조

* 32개의 레지스터(* 레지스터: ALU에 중간 계산 결과 값을 저장한다.)
  - ALU에 직접 연결
  - 1클럭 사이클 내에 하나의 명령어로 두 개의 레지스터를 액세스
  * CISC 마이크로컨트롤러에 비해 약 10배 정도 효율
* 처리 성능: 16MHz ~ 16MIPS
* 2클록 사이클이 소요되는 곱셈기를 칩에 내장

#### 3.2.2 비휘발성 프로그램과 데이터 메모리

* ISP 방식의 플래시 메모리 내장: 10,000회 읽기/쓰기 가능
* 4Kbyte의 EEPROM(*ROM: 원래는 한 번 기록하고 나면 다시 기록할 수 없) 100,000회 읽기 / 쓰기 가능
* 4Kbyte의 SRAM 내장
* 외부 추가 사용 가능 메모리 공간: 64Kbyte까지
* SPI 인터페이스를 이용한 ISP(In System Programming) 가능

참고
RAM  | ROM
-----|-------
휘발성 | 비휘발성
여러번 읽고 쓸 수 있음 | 여러번 읽을 수는 있으나 한 번만 기록할 수 있음.

#### 3.2.3 주변창치(Peripheral Device)

1. 7개의 I/O 포트
  - 8비트 I/O 포트 - A, B, C, D, E, F
  - 5비트 I/O 포트 - G
2. 2개의 8비트 타이머/카운터
  - 별도의 프리스케일러와 비교 모드 동작
3. 2개의 16비트 타이머/카운터
  - 별도의 프리스케일러, 비교모드, 캡처 모드 동작
4. 발진 회로와 분리된 실시간 타이머 카운터
5. 6개의 PWM 채널: 2~16비트까지 조정 가능
6. 출력 비교 모듈레이터
7. 2개의 USART
8. 아날로그 비교기
9. 8채널의 10비트 A/D 변환기 (ADC:Analog to Digital Converter)
  - 8개의 단극성 입력 채널: 그라운드(GND) 신호와 입력 신호(Vi) 사이의 전위차
  - 7개의 차동 입력 채널: 두 입력 신호 사이의 전위차 (Vp-Vn)
  - 2개의 프로그램 가능한 입력 이득(1x, 10x, 200x)을 갖는 채널
10. 2선식 직렬 인터페이스(TWI: Two-wire Serial Interface): 바이트 지향
11. 2개의 USART: RS232통신, RS485 통신 등에 적용
12. Master/Slave SPI 직렬 인터페이스
13. 프로그램 가능한 와치독 타이머 (Watchdog Timer): 내부 발진 회로와 연결
14. JTAG(IEEE std. 1149.1 호환) 인터페이스
  * JTAG 표준에 따른 Boundary-scan 수용
  * 온-칩 디버깅 지원
  * JTAG 인터페이스를 통해 플래쉬, EEPROM, 휴즈, 락비트 프로그래밍

      [참고] JTAG 인터페이스
        - 칩데이터
        - FPGA 구울 때 쓴다.
        - 디버깅하고 플래시 메모리 프로그래밍 (ISP) 할 때 쓴다.

### 3.3 ATmega128의 내장 기능

#### 3.3.1 특수기능

* Power-On 리셋: 외부 별도 리셋 회로 없이 전원 인가 (레지스터 초기화)
* 브라운아웃(Brown-Out) 전압 검출: 2.7V 또는 4.3 이하의 전원 전압을 검출
* 프로그램으로 조율이 가능한 내부 RC 발진 회로
* 6개의 휴먼 모드: Idle, A/D 변환기 잡음 제거, 파워-세이브(Power-Save), 파워-다운(Power-down), 대기(Standby), 확장 대기(Extended Standby)
* 소프트웨어적으로 선택 가능한 클럭 주파수
* 휴즈 비트로 ATmega103호환 모드 선택
* 전체 풀업(Pull-up) 저항해제

### 3.4 ATmega128의 내부 구조

#### 3.4.1 주요 구성 요소

1. 8-bit ALU
2. 내장 메모리

2.1. 플래시 프로그램 메모리

- 특징 : 비휘발성 메모리
- 용량: 128Kbyte
- 10,000 쓰기, 지우기 반복 가능

2.2. 데이터 메모리(SRAM)

- 프로그램에 선언한 변수와 스택을 위해 읽고 쓰기를 빠르게 수행할 수 있는 주 메모리(휘발성 메모리)
- 용량: 4Kbyte

2.3 EEPROM

- 프로그램 실행 중 생성된 데이터 전원 없이도 유지
- SRAM, 플래시 프로그램 메모리보다 시간이 오래 걸림
- 용량: 4Kbyte

3. 입출력 장치

4. 기타

- 패키지: 64핀
- 동작 주파수: ~16MHz
- 동작 환경: -40~80℃
- 전원전압: 2.7~5.5V

#### 3.4.2 ATmega128의 내부 구조

1. On-Chip I/O Device

* GPIO(General Purpose I/O)
  - 범용 입출력 포트로 53개의 프로그램 가능
  - 6개의 8bit 포트: A, B, C, D, E, F 포트

2. Peripheral Device

* 타이머
  - 8-Bit 2개, 16-Bit 2개의 8-Bit 타이머
  - 실시간 클럭(Real Time CLock) 구성 가능

* Watchdog 타이머
  - 타임아웃 주기를 프로그램 가능
  - 별도 내부 발진기 사용

* PWM(Plus Width Modulation)
  - 입력 값에 따라 펄스 폭 변조
  - 2채널의 8-Bit, 6-채널의 PMW

* 아날로그 인터페이스
  - 8-채널의 10-Bit ADC
  - 아날로그 비교기

* USART
  - 범용 동기/비동기 시리얼 포트
  - 2-포트

* SPI(Serial Peripheral Interface)
  - 전이중 동기 시리얼 인터페이스
  - 플래시 메모리 프로그램에 사용
  - 3선(MISO(Master In Slave Out: Output From Master), MOSI(Master Out Slave In: Data output from master), SCLK(Serial CLock: Ouput from master)) 사용
  - 최대 전송속도: 시스템 클럭 주파수 / 4

* TWI(Two-wire Serial Interface)
  - 동기 시리얼 인터페이스
  - 필립스의 Inter-IC와 동일
  - 2-선 (SDA(Serial Data), SCL(Serial Clocks)) 사용
  - 전송속도: 400KHz

* 프로그램 카운터 (Program Counter)
  - 플래시 프로그램 메모리 공간을 가리킨다.
  - 명령어를 차례로 인출하면서 응용프로그램을 실행한다.
  - 다음에 수행할 명령어의 address를 가진다.

* 명령어 레지스터
  - 프로그램 카운터가 지칭한 곳에서 명령어 레지스터로 명령어 인출
  - 명령어에는 명령코드, 오퍼랜드, 연산 결과 저장 위치 필드를 가짐

* 명령어 디코더
  - 명령어 레지스터의 명령 코드를 디코딩해서 제어 신호를 생성한다.
  - ALU는 명령코드에 해당되는 연산동작을 수행하게 한다.
  - 제어 신호는 연산 대상이 되는 오퍼랜드가 ALU에 전달되게 한다.
  - 제어 신호는 연산결과를 저장할 수 있게 한다.

* 스택포인터
  - 스택은 임시데이터, 로컬변수, 호출된 함수의 복귀 주소 등을 저장한다.
  - 스택 포인터(Stack Pointer)는 스택의 TOP을 저장하는 특수 레지스터
  - 스택 데이터가 저장되면 스택 공간은 커진다.
  - 스택 포인터의 주소는 높은 값에서 낮은 값으로 감소
  - PUSH 명령어: 데이터가 스택에 저장 (스택 포인터는 1씩 증가한다.)
  - POP 명령어: 데이터를 스택의 TOP에서 꺼냄.

#### 3.4.2 ATmega128의 동작환경

* 동작 주파수
  * ATMega128A: ~16MHz
  * ATmega128: ~16MHz
  * ATmega128L: ~8MHz

* 공급 전원
  * ATmega128A: 2.7 ~ 5.5V
  * ATmega128: 4.5 ~ 5.5V
  * ATmega128L: 2.7 ~ 5.5V

* 동작 온도
  * 상용: 0 ~ 70도
  * 산업용: -40 ~ 85도

* ATmega128의 패키지
  * 64-lead TQFP(Thin Quad Flat Package)
  * 64-pad MLF(Micro Lead Frame)

* ATmega128의 핀
  * 64개의 핀
  * 패키지는 TQFP(Thin Quad Flat Package)와 MLF(Micro Lead Frame)
  * 기본용도: 입출력 포트용
  * 대체용도: 프로세서에 내장된 입출력 장치의 신호선